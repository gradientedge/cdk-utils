<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>construct/api-to-eventbridge-target/main.ts - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <link type="text/css" rel="stylesheet" href="main.css">
    <script src="scripts/nav.js" defer></script>
    
    <script src="scripts/commonNav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
</nav>

<div id="main">
    
    <h1 class="page-title">construct/api-to-eventbridge-target/main.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as cdk from 'aws-cdk-lib'
import * as apig from 'aws-cdk-lib/aws-apigateway'
import * as events from 'aws-cdk-lib/aws-events'
import * as eventstargets from 'aws-cdk-lib/aws-events-targets'
import * as iam from 'aws-cdk-lib/aws-iam'
import * as secretsmanager from 'aws-cdk-lib/aws-secretsmanager'
import { Construct } from 'constructs'
import { CommonConstruct } from '../../common'
import {
  ApiToEventBridgeTargetEventType,
  ApiToEventBridgeTargetProps,
  ApiToEventBridgeTargetRestApiType,
} from './types'
import { ApiToEventbridgeTargetEvent } from './event'
import { ApiToEventbridgeTargetRestApi } from './api'

/**
 * @classdesc Provides a construct to create and deploy API Gateway invocations to EventBridge
 *
 * &lt;b>Architecture&lt;/b>&lt;br/> ![Architecture](./ApiToEventBridgeTarget.jpg)
 * @example
 * import { ApiToEventBridgeTarget, ApiToEventBridgeTargetProps } '@gradientedge/cdk-utils'
 * import { Construct } from 'constructs'
 *
 * class CustomConstruct extends ApiToEventBridgeTarget {
 *   constructor(parent: Construct, id: string, props: ApiToEventBridgeTargetProps) {
 *     super(parent, id, props)
 *     this.props = props
 *     this.id = id
 *     this.initResources()
 *   }
 * }
 */
export class ApiToEventBridgeTarget extends CommonConstruct {
  props: ApiToEventBridgeTargetProps
  id: string

  /* application related resources */
  applicationSecrets: secretsmanager.ISecret[]

  /* event related resources */
  apiEvent: ApiToEventBridgeTargetEventType

  /* rest restApi related resources */
  apiToEventBridgeTargetRestApi: ApiToEventBridgeTargetRestApiType
  apiResource: string

  constructor(parent: Construct, id: string, props: ApiToEventBridgeTargetProps) {
    super(parent, id, props)

    this.props = props
    this.id = id

    this.apiEvent = new ApiToEventbridgeTargetEvent()
    this.apiToEventBridgeTargetRestApi = new ApiToEventbridgeTargetRestApi()
    this.apiResource = 'notify'
  }

  protected initResources() {
    /* application related resources */
    this.resolveSecrets()

    /* core resources */
    this.resolveHostedZone()
    this.resolveCertificate()

    /* optional custom event bus */
    this.createApiToEventBridgeTargetEventBus()

    /* event related resources */
    this.createApiToEventBridgeTargetLogGroup()
    this.createApiToEventBridgeTargetRule()
    this.createApiToEventBridgeTargetPolicy()
    this.createApiToEventBridgeTargetRole()

    /* restApi related resources */
    this.createApiToEventBridgeTargetIntegrationRequestParameters()
    this.createApiToEventBridgeTargetIntegrationRequestTemplates()
    this.createApiToEventBridgeTargetIntegrationResponse()
    this.createApiToEventBridgeTargetIntegrationErrorResponse()
    this.createApiToEventBridgeTargetIntegration()
    this.createApiToEventBridgeTargetRestApiLogGroup()
    this.createApiToEventBridgeTargetRestApi()
    this.createApiToEventBridgeTargetResource()
    this.createApiToEventBridgeTargetResponseModel()
    this.createApiToEventBridgeTargetErrorResponseModel()
    this.createApiToEventBridgeTargetMethodResponse()
    this.createApiToEventBridgeTargetMethodErrorResponse()
    this.createApiToEventBridgeTargetResourceMethod()
    this.createApiDomain()
    this.createApiBasePathMapping()
    this.createApiRouteAssets()
  }

  /**
   * @summary Method to resolve secrets from SecretsManager
   * - To be implemented in the overriding method in the implementation class
   */
  protected resolveSecrets() {
    this.applicationSecrets = []
  }

  /**
   * @summary Method to resolve a hosted zone based on domain attributes
   */
  protected resolveHostedZone() {
    this.apiToEventBridgeTargetRestApi.hostedZone = this.route53Manager.withHostedZoneFromFullyQualifiedDomainName(
      `${this.id}-hosted-zone`,
      this,
      this.props.useExistingHostedZone
    )
  }

  /**
   * @summary Method to resolve a certificate based on attributes
   */
  protected resolveCertificate() {
    if (this.props.api.useExisting) return
    if (
      this.props.api.certificate.useExistingCertificate &amp;&amp;
      this.props.api.certificate.certificateSsmName &amp;&amp;
      this.props.api.certificate.certificateRegion
    ) {
      this.props.api.certificate.certificateArn = this.ssmManager.readStringParameterFromRegion(
        `${this.id}-certificate-param`,
        this,
        this.props.api.certificate.certificateSsmName,
        this.props.api.certificate.certificateRegion
      )
    }

    this.apiToEventBridgeTargetRestApi.certificate = this.acmManager.resolveCertificate(
      `${this.id}-certificate`,
      this,
      this.props.api.certificate
    )
  }

  /**
   * @summary Method to create or use an existing eventbus for api payload deliveries
   */
  protected createApiToEventBridgeTargetEventBus() {
    if (this.props.api.useExisting) {
      this.apiEvent.eventBus = events.EventBus.fromEventBusName(
        this,
        `${this.id}-event-bus`,
        `${this.props.event.eventBusName}-${this.props.stage}`
      )
      return
    }
    this.apiEvent.eventBus = this.eventManager.createEventBus(`${this.id}-event-bus`, this, {
      eventBusName: `${this.props.event.eventBusName}`,
    })
  }

  /**
   * @summary Method to create a log group for successful api payload deliveries
   */
  protected createApiToEventBridgeTargetLogGroup() {
    if (this.props.api.useExisting) return
    this.apiEvent.logGroup = this.logManager.createLogGroup(`${this.id}-log`, this, {
      ...{
        logGroupName: `/${this.id}/events/api-to-eventbridge-target`,
      },
      ...this.props.event.logGroup,
    })
  }

  /**
   * Method to create EventBridge rule with lambda target for success
   */
  protected createApiToEventBridgeTargetRule() {
    if (this.props.api.useExisting) return
    this.props.event.rule = {
      ...{
        eventPattern: {
          source: ['api-to-eventbridge-target'],
        },
        ruleName: `${this.id}-api-to-eventbridge-target`,
      },
      ...this.props.event.rule,
    }
    this.apiEvent.rule = this.eventManager.createRule(
      `${this.id}-api-to-eventbridge-target-rule`,
      this,
      this.props.event.rule,
      this.apiEvent.eventBus,
      [new eventstargets.CloudWatchLogGroup(this.apiEvent.logGroup)]
    )
  }

  protected createApiToEventBridgeTargetPolicy() {
    this.apiToEventBridgeTargetRestApi.policy = new iam.PolicyDocument({
      statements: [this.iamManager.statementForPutEvents()],
    })
  }

  /**
   * @summary Method to create a role for api integration
   */
  protected createApiToEventBridgeTargetRole() {
    if (!this.apiToEventBridgeTargetRestApi.policy) throw 'Policy undefined'

    this.apiToEventBridgeTargetRestApi.role = new iam.Role(this, `${this.id}-rest-api-role`, {
      assumedBy: new iam.ServicePrincipal('apigateway.amazonaws.com'),
      inlinePolicies: { policy: this.apiToEventBridgeTargetRestApi.policy },
    })
  }

  /**
   * @summary Method to create api integration request parameters
   */
  protected createApiToEventBridgeTargetIntegrationRequestParameters() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.integrationRequestParameters = {
      'integration.request.header.Content-Type': "'application/x-www-form-urlencoded'",
    }
  }

  /**
   * @summary Method to create api integration request templates
   */
  protected createApiToEventBridgeTargetIntegrationRequestTemplates() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.integrationRequestTemplates = {
      'application/json': [
        '#set($context.requestOverride.header.X-Amz-Target = "AWSEvents.PutEvents")',
        '#set($context.requestOverride.header.Content-Type = "application/x-amz-json-1.1")',
        `{
          "Entries": [
            {
              "EventBusName": "${this.apiEvent.eventBus.eventBusName}",
              "Source": "api-to-eventbridge-target",
              "DetailType": "$util.escapeJavaScript($context.domainName)$util.escapeJavaScript($context.resourcePath)",
              "Detail": "$util.escapeJavaScript($input.body).replaceAll("\\\\'","'")"
            }
          ]
        }`,
      ].join('\r'),
    }
  }

  /**
   * @summary Method to create api integration response
   */
  protected createApiToEventBridgeTargetIntegrationResponse() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.integrationResponse = this.props.api.integrationResponse ?? {
      ...{
        responseTemplates: {
          'application/json': JSON.stringify({ message: 'Payload Submitted' }),
        },
        statusCode: '200',
      },
    }
  }

  /**
   * @summary Method to create api integration error response
   */
  protected createApiToEventBridgeTargetIntegrationErrorResponse() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.integrationErrorResponse = {
      ...{
        responseParameters: {
          'method.response.header.Access-Control-Allow-Credentials': "'true'",
          'method.response.header.Access-Control-Allow-Origin': "'*'",
          'method.response.header.Content-Type': "'application/json'",
        },
        responseTemplates: {
          'application/json': JSON.stringify({
            message: "$util.escapeJavaScript($input.path('$.errorMessage'))",
            state: 'error',
          }),
        },
        selectionPattern: '^\\[Error\\].*',
        statusCode: '400',
      },
      ...this.props.api.integrationErrorResponse,
    }
  }

  /**
   * @summary Method to create api integration
   */
  protected createApiToEventBridgeTargetIntegration() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.integration = new apig.Integration({
      integrationHttpMethod: 'POST',
      options: {
        ...{
          credentialsRole: this.apiToEventBridgeTargetRestApi.role,
          integrationResponses: [
            this.apiToEventBridgeTargetRestApi.integrationResponse,
            this.apiToEventBridgeTargetRestApi.integrationErrorResponse,
          ],
          passthroughBehavior: apig.PassthroughBehavior.NEVER,
          requestParameters: this.apiToEventBridgeTargetRestApi.integrationRequestParameters,
          requestTemplates: this.apiToEventBridgeTargetRestApi.integrationRequestTemplates,
        },
        ...this.props.api.integrationOptions,
      },
      type: apig.IntegrationType.AWS,
      uri: `arn:aws:apigateway:${this.props.region}:events:path//`,
    })
  }

  /**
   * @summary Method to create api integration method response
   */
  protected createApiToEventBridgeTargetMethodResponse() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.methodResponse = {
      ...{
        responseModels: {
          'application/json': this.apiToEventBridgeTargetRestApi.responseModel,
        },
        responseParameters: {
          'method.response.header.Access-Control-Allow-Credentials': true,
          'method.response.header.Access-Control-Allow-Origin': true,
          'method.response.header.Content-Type': true,
        },
        statusCode: '200',
      },
      ...this.props.api.methodResponse,
    }
  }

  /**
   * @summary Method to create api integration method error response
   */
  protected createApiToEventBridgeTargetMethodErrorResponse() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.methodErrorResponse = {
      ...{
        responseModels: {
          'application/json': this.apiToEventBridgeTargetRestApi.errorResponseModel,
        },
        responseParameters: {
          'method.response.header.Access-Control-Allow-Credentials': true,
          'method.response.header.Access-Control-Allow-Origin': true,
          'method.response.header.Content-Type': true,
        },
        statusCode: '400',
      },
      ...this.props.api.methodErrorResponse,
    }
  }

  protected createApiToEventBridgeTargetRestApiLogGroup() {
    this.apiToEventBridgeTargetRestApi.accessLogGroup = this.logManager.createLogGroup(
      `${this.id}-rest-api-access-log`,
      this,
      {
        logGroupName: `/custom/api/${this.id}-rest-api-access`,
        removalPolicy: cdk.RemovalPolicy.DESTROY,
      }
    )
  }

  /**
   * @summary Method to create rest restApi for Api
   */
  protected createApiToEventBridgeTargetRestApi() {
    if (this.props.api.useExisting &amp;&amp; this.props.api.importedRestApiRef) {
      this.apiToEventBridgeTargetRestApi.api = apig.RestApi.fromRestApiId(
        this,
        `${this.id}-rest-api`,
        cdk.Fn.importValue(this.props.api.importedRestApiRef)
      )
      return
    }

    this.apiToEventBridgeTargetRestApi.api = new apig.RestApi(this, `${this.id}-rest-api`, {
      ...{
        cloudWatchRole: this.props.api.restApi?.cloudWatchRole ?? true,
        defaultCorsPreflightOptions: {
          allowHeaders: apig.Cors.DEFAULT_HEADERS,
          allowMethods: ['POST'],
          allowOrigins: apig.Cors.ALL_ORIGINS,
        },
        defaultIntegration: this.apiToEventBridgeTargetRestApi.integration,
        defaultMethodOptions: {
          methodResponses: [
            this.apiToEventBridgeTargetRestApi.methodResponse,
            this.apiToEventBridgeTargetRestApi.methodErrorResponse,
          ],
        },
        deploy: this.props.api.restApi?.deploy ?? true,
        deployOptions: {
          accessLogDestination: new apig.LogGroupLogDestination(this.apiToEventBridgeTargetRestApi.accessLogGroup),
          accessLogFormat: apig.AccessLogFormat.jsonWithStandardFields(),
          dataTraceEnabled: this.props.api.restApi?.deployOptions?.dataTraceEnabled,
          description: `${this.id} - ${this.props.stage} stage`,
          loggingLevel: apig.MethodLoggingLevel.INFO,
          metricsEnabled: true,
          stageName: this.props.stage,
          tracingEnabled: this.props.api.restApi?.deployOptions?.tracingEnabled,
        },
        endpointConfiguration: {
          types: [apig.EndpointType.REGIONAL],
        },
        restApiName: `${this.id}-rest-api-${this.props.stage}`,
      },
      ...this.props.api.restApi,
    })
    this.addCfnOutput(`${this.id}-restApiId`, this.apiToEventBridgeTargetRestApi.api.restApiId)
    this.addCfnOutput(`${this.id}-restApiRootResourceId`, this.apiToEventBridgeTargetRestApi.api.root.resourceId)
  }

  /**
   * @summary Method to create api integration response model
   */
  protected createApiToEventBridgeTargetResponseModel() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.responseModel = new apig.Model(this, `${this.id}-response-model`, {
      restApi: this.apiToEventBridgeTargetRestApi.api,
      ...{
        contentType: 'application/json',
        modelName: 'ResponseModel',
        schema: {
          properties: { message: { type: apig.JsonSchemaType.STRING } },
          schema: apig.JsonSchemaVersion.DRAFT4,
          title: 'pollResponse',
          type: apig.JsonSchemaType.OBJECT,
        },
      },
      ...this.props.api.responseModel,
    })
  }

  /**
   * @summary Method to create api integration error response model
   */
  protected createApiToEventBridgeTargetErrorResponseModel() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.errorResponseModel = new apig.Model(this, `${this.id}-error-response-model`, {
      restApi: this.apiToEventBridgeTargetRestApi.api,
      ...{
        contentType: 'application/json',
        modelName: 'ErrorResponseModel',
        schema: {
          properties: {
            message: { type: apig.JsonSchemaType.STRING },
            state: { type: apig.JsonSchemaType.STRING },
          },
          schema: apig.JsonSchemaVersion.DRAFT4,
          title: 'errorResponse',
          type: apig.JsonSchemaType.OBJECT,
        },
      },
      ...this.props.api.errorResponseModel,
    })
  }

  /**
   * @summary Method to create api integration resource
   */
  protected createApiToEventBridgeTargetResource() {
    if (!this.props.api.withResource) return

    let rootResource
    if (this.props.api.withResource &amp;&amp; this.props.api.importedRestApiRootResourceRef) {
      rootResource = apig.Resource.fromResourceAttributes(this, `${this.id}-root-resource`, {
        path: '/',
        resourceId: cdk.Fn.importValue(this.props.api.importedRestApiRootResourceRef),
        restApi: this.apiToEventBridgeTargetRestApi.api,
      })
    } else {
      rootResource = this.apiToEventBridgeTargetRestApi.api.root
    }

    this.apiToEventBridgeTargetRestApi.resource = rootResource.addResource(this.props.api.resource ?? this.apiResource)
  }

  /**
   * @summary Method to create api integration resource method
   */
  protected createApiToEventBridgeTargetResourceMethod() {
    if (!this.props.api.withResource) return
    this.apiToEventBridgeTargetRestApi.method = this.apiToEventBridgeTargetRestApi.resource.addMethod(
      'POST',
      this.apiToEventBridgeTargetRestApi.integration,
      {
        authorizer: this.apiToEventBridgeTargetRestApi.authoriser,
        methodResponses: [
          this.apiToEventBridgeTargetRestApi.methodResponse,
          this.apiToEventBridgeTargetRestApi.methodErrorResponse,
        ],
      }
    )
  }

  /**
   * @summary Method to create custom restApi domain for Api
   */
  protected createApiDomain() {
    if (this.props.api.useExisting) return
    this.apiToEventBridgeTargetRestApi.domain = this.apiManager.createApiDomain(
      `${this.id}-api-domain`,
      this,
      this.isProductionStage() || this.props.skipStageForARecords
        ? `${this.props.apiSubDomain}.${this.fullyQualifiedDomainName}`
        : `${this.props.apiSubDomain}-${this.props.stage}.${this.fullyQualifiedDomainName}`,
      this.apiToEventBridgeTargetRestApi.certificate
    )
  }

  /**
   * @summary Method to create base path mappings for Api
   */
  protected createApiBasePathMapping() {
    if (this.props.api.useExisting) return
    new apig.BasePathMapping(this, `${this.id}-base-bath-mapping`, {
      basePath: '',
      domainName: this.apiToEventBridgeTargetRestApi.domain,
      restApi: this.apiToEventBridgeTargetRestApi.api,
      stage: this.apiToEventBridgeTargetRestApi.api.deploymentStage,
    })
  }

  /**
   * @summary Method to create route53 records for Api
   */
  protected createApiRouteAssets() {
    if (this.props.api.useExisting) return
    this.route53Manager.createApiGatewayARecord(
      `${this.id}-custom-domain-a-record`,
      this,
      this.props.apiSubDomain,
      this.apiToEventBridgeTargetRestApi.domain,
      this.apiToEventBridgeTargetRestApi.hostedZone,
      this.props.skipStageForARecords
    )
  }
}
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<footer>
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
